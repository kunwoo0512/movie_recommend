<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ movie.title }} - ì˜í™” ìƒì„¸ ì •ë³´</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/movie_detail.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-film"></i>
                    <span>MovieFinder</span>
                </div>
                <nav class="nav">
                    <a href="/" class="nav-link">
                        <i class="fas fa-home"></i>
                        <span>í™ˆìœ¼ë¡œ</span>
                    </a>
                </nav>
            </div>
        </header>

        <!-- ì˜í™” ìƒì„¸ ì •ë³´ -->
        <main class="detail-content">
            <div class="detail-container">
                <!-- ë’¤ë¡œê°€ê¸° -->
                <div class="breadcrumb">
                    <a href="javascript:history.back()" class="back-link">
                        <i class="fas fa-arrow-left"></i>
                        ê²€ìƒ‰ ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                    {% if query %}
                    <span class="breadcrumb-separator">â†’</span>
                    <span class="search-query">"{{ query }}" ê²€ìƒ‰ ê²°ê³¼</span>
                    {% endif %}
                </div>

                <!-- ì˜í™” ì •ë³´ ì¹´ë“œ -->
                <div class="movie-detail-card">
                    <div class="movie-poster-section">
                        <div class="movie-poster-large">
                            {% if movie.poster_url %}
                                <img src="{{ movie.poster_url }}" alt="{{ movie.title }}" onerror="this.style.display='none'; this.parentElement.classList.add('no-poster');">
                            {% else %}
                                <div class="poster-fallback">
                                    <i class="fas fa-film"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="movie-rating">
                            <div class="rating-badge">
                                <i class="fas fa-star"></i>
                                {% if movie.llm_analysis and movie.llm_analysis.score %}
                                    <span>{{ movie.llm_analysis.score }}/10</span>
                                {% else %}
                                    <span>{{ "%.1f"|format(movie.score * 10) }}/10</span>
                                {% endif %}
                            </div>
                            {% if movie.llm_analysis and movie.llm_analysis.score %}
                                <p class="rating-label">LLM ë¶„ì„ ì ìˆ˜</p>
                            {% else %}
                                <p class="rating-label">ìœ ì‚¬ë„ ì ìˆ˜</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="movie-info-section">
                        <div class="movie-title-section">
                            <h1 class="movie-title">{{ movie.title }}</h1>
                            <div class="movie-metadata">
                                <span class="movie-year">
                                    <i class="fas fa-calendar"></i>
                                    {{ movie.year }}
                                </span>
                                <span class="movie-director">
                                    <i class="fas fa-user"></i>
                                    {{ movie.director }}
                                </span>
                            </div>
                        </div>

                        <!-- LLM ë¶„ì„ -->
                        {% if movie.llm_analysis and movie.llm_analysis.reason %}
                        <div class="llm-analysis">
                            <h3>
                                <i class="fas fa-lightbulb"></i>
                                ì™œ ì´ ì˜í™”ê°€ ì¶”ì²œë˜ì—ˆì„ê¹Œìš”?
                            </h3>
                            <div class="analysis-content">
                                <div class="llm-score">
                                    <span class="score-label">LLM ë¶„ì„ ì ìˆ˜:</span>
                                    <span class="score-value">{{ movie.llm_analysis.score }}/10</span>
                                </div>
                                <p class="analysis-text">{{ movie.llm_analysis.reason }}</p>
                            </div>
                        </div>
                        {% endif %}

                        <!-- ì¤„ê±°ë¦¬ -->
                        <div class="plot-section">
                            <h3>
                                <i class="fas fa-book"></i>
                                ì¤„ê±°ë¦¬
                            </h3>
                            <p class="plot-text">{{ movie.plot or 'ì¤„ê±°ë¦¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.' }}</p>
                        </div>

                        <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
                        <div class="action-buttons">
                            <button class="action-btn primary" onclick="searchSimilar()">
                                <i class="fas fa-search"></i>
                                ë¹„ìŠ·í•œ ì˜í™” ë” ì°¾ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- ê´€ë ¨ì˜í™” ì¶”ì²œ ì„¹ì…˜ -->
        <section class="related-movies-section">
            <div class="container">
                <h2 class="section-title">
                    <i class="fas fa-film"></i>
                    ì´ëŸ° ì˜í™”ëŠ” ì–´ë– ì„¸ìš”?
                </h2>
                
                <!-- ê°€ì¤‘ì¹˜ ì¡°ì ˆ ì„¹ì…˜ -->
                <div class="weight-controls">
                    <h3 class="weight-title">
                        <i class="fas fa-sliders-h"></i>
                        ê´€ë ¨ì˜í™” íƒìƒ‰ ìš”ê±´
                    </h3>
                    <div class="weight-sliders">
                        <div class="weight-item plot">
                            <label for="plotWeight">ì¤„ê±°ë¦¬</label>
                            <div class="slider-container">
                                <input type="range" id="plotWeight" min="0" max="1" step="0.1" value="0.8" class="weight-slider plot">
                                <span class="weight-value" id="plotValue">80%</span>
                            </div>
                        </div>
                        
                        <div class="weight-item flow">
                            <label for="flowWeight">íë¦„ê³¡ì„ </label>
                            <div class="slider-container">
                                <input type="range" id="flowWeight" min="0" max="1" step="0.1" value="0.1" class="weight-slider flow">
                                <span class="weight-value" id="flowValue">10%</span>
                            </div>
                        </div>
                        
                        <div class="weight-item genre">
                            <label for="genreWeight">ì¥ë¥´</label>
                            <div class="slider-container">
                                <input type="range" id="genreWeight" min="0" max="1" step="0.1" value="0.1" class="weight-slider genre">
                                <span class="weight-value" id="genreValue">10%</span>
                            </div>
                        </div>
                        
                        <button class="apply-weights-btn" onclick="applyWeightsAndReload()">
                            <i class="fas fa-sync-alt"></i>
                            ë³€ê²½
                        </button>
                    </div>
                </div>
                
                <div class="related-movies-grid" id="relatedMoviesGrid">
                    <!-- ê´€ë ¨ì˜í™”ê°€ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                    <div class="loading-related">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>ê´€ë ¨ì˜í™”ë¥¼ ì°¾ëŠ” ì¤‘...</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- í‘¸í„° -->
        <footer class="footer">
            <p>&copy; 2025 MovieFinder. AI ê¸°ë°˜ ì˜í™” ì¶”ì²œ ì‹œìŠ¤í…œ</p>
        </footer>
    </div>

    <script>
        // í˜ì´ì§€ ë¡œë“œì‹œ ê´€ë ¨ì˜í™” ë¡œë“œ ë° ê°€ì¤‘ì¹˜ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeWeightSliders();
            // ê¸°ë³¸ ê°€ì¤‘ì¹˜ë¡œ ê´€ë ¨ì˜í™” ë¡œë“œ (ìºì‹± ë°©ì§€)
            loadRelatedMoviesWithWeights(0.8, 0.1, 0.1);
        });

        // ê°€ì¤‘ì¹˜ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
        function initializeWeightSliders() {
            const plotSlider = document.getElementById('plotWeight');
            const flowSlider = document.getElementById('flowWeight');
            const genreSlider = document.getElementById('genreWeight');
            
            // ìŠ¬ë¼ì´ë” ê°’ ë³€ê²½ ì‹œ í‘œì‹œê°’ ì—…ë°ì´íŠ¸
            plotSlider.addEventListener('input', function() {
                document.getElementById('plotValue').textContent = Math.round(this.value * 100) + '%';
            });
            
            flowSlider.addEventListener('input', function() {
                document.getElementById('flowValue').textContent = Math.round(this.value * 100) + '%';
            });
            
            genreSlider.addEventListener('input', function() {
                document.getElementById('genreValue').textContent = Math.round(this.value * 100) + '%';
            });
        }

        // ê°€ì¤‘ì¹˜ ì ìš© ë° ê´€ë ¨ì˜í™” ì¬ë¡œë“œ
        function applyWeightsAndReload() {
            const plotWeight = document.getElementById('plotWeight').value;
            const flowWeight = document.getElementById('flowWeight').value;
            const genreWeight = document.getElementById('genreWeight').value;
            
            // ê°€ì¤‘ì¹˜ í•©ì´ 1ì´ ë˜ë„ë¡ ì •ê·œí™”
            const total = parseFloat(plotWeight) + parseFloat(flowWeight) + parseFloat(genreWeight);
            if (total === 0) {
                alert('ìµœì†Œ í•˜ë‚˜ì˜ ê°€ì¤‘ì¹˜ëŠ” 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            const normalizedPlot = (parseFloat(plotWeight) / total);
            const normalizedFlow = (parseFloat(flowWeight) / total);
            const normalizedGenre = (parseFloat(genreWeight) / total);
            
            // í˜„ì¬ ê°€ì¤‘ì¹˜ ì—…ë°ì´íŠ¸
            currentWeights.plot = normalizedPlot;
            currentWeights.flow = normalizedFlow;
            currentWeights.genre = normalizedGenre;
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            const btn = document.querySelector('.apply-weights-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì ìš© ì¤‘...';
            btn.disabled = true;
            
            // ë¡œë”© ìƒíƒœë¡œ ë³€ê²½
            document.getElementById('relatedMoviesGrid').innerHTML = `
                <div class="loading-related">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>ìƒˆë¡œìš´ ê°€ì¤‘ì¹˜ë¡œ ì˜í™”ë¥¼ ì°¾ëŠ” ì¤‘...</span>
                </div>
            `;
            
            // ìƒˆ ê°€ì¤‘ì¹˜ë¡œ ê´€ë ¨ì˜í™” ë¡œë“œ
            loadRelatedMoviesWithWeights(normalizedPlot, normalizedFlow, normalizedGenre);
        }

        // ê°€ì¤‘ì¹˜ë¥¼ ì ìš©í•œ ê´€ë ¨ì˜í™” ë¡œë“œ
        function loadRelatedMoviesWithWeights(plotWeight, flowWeight, genreWeight) {
            const movieTitle = "{{ movie.title }}";
            const movieYear = "{{ movie.year }}";
            
            console.log(`ğŸ” API í˜¸ì¶œ: ${movieTitle} (${movieYear}) - ê°€ì¤‘ì¹˜: plot=${plotWeight}, flow=${flowWeight}, genre=${genreWeight}`);
            
            fetch('/api/related-movies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: movieTitle,
                    year: movieYear,
                    top_k: 6,
                    plot_weight: plotWeight,
                    flow_weight: flowWeight,
                    genre_weight: genreWeight
                })
            })
            .then(response => {
                console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('ğŸ“Š API ì‘ë‹µ ë°ì´í„°:', data);
                displayRelatedMovies(data.movies || []);
                
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                const btn = document.querySelector('.apply-weights-btn');
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> ë³€ê²½';
                btn.disabled = false;
            })
            .catch(error => {
                console.error('ê´€ë ¨ì˜í™” ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('relatedMoviesGrid').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>ê´€ë ¨ì˜í™”ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>
                    </div>
                `;
                
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                const btn = document.querySelector('.apply-weights-btn');
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> ë³€ê²½';
                btn.disabled = false;
            });
        }

        // ê´€ë ¨ì˜í™” ë¡œë“œ
        function loadRelatedMovies() {
            const movieTitle = "{{ movie.title }}";
            const movieYear = "{{ movie.year }}";
            
            fetch('/api/related-movies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: movieTitle,
                    year: movieYear,
                    top_k: 6
                })
            })
            .then(response => response.json())
            .then(data => {
                displayRelatedMovies(data.movies || []);
            })
            .catch(error => {
                console.error('ê´€ë ¨ì˜í™” ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('relatedMoviesGrid').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>ê´€ë ¨ì˜í™”ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>
                    </div>
                `;
            });
        }

        // ê´€ë ¨ì˜í™” í‘œì‹œ
        function displayRelatedMovies(movies) {
            const grid = document.getElementById('relatedMoviesGrid');
            
            if (movies.length === 0) {
                grid.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-film"></i>
                        <span>ê´€ë ¨ì˜í™”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>
                    </div>
                `;
                return;
            }

            const moviesHTML = movies.map(movie => `
                <div class="related-movie-card" onclick="compareMovies('${movie.title}', '${movie.year}')">
                    <div class="related-poster">
                        ${movie.poster_url ? 
                            `<img src="${movie.poster_url}" alt="${movie.title}" />` : 
                            `<div class="poster-placeholder"><i class="fas fa-film"></i></div>`
                        }
                    </div>
                    <div class="related-info">
                        <h4 class="related-title">${movie.title}</h4>
                        <p class="related-year">${movie.year}</p>
                        <div class="similarity-score">
                            <i class="fas fa-star"></i>
                            <span>${(movie.similarity_score * 100).toFixed(1)}% ìœ ì‚¬</span>
                        </div>
                    </div>
                </div>
            `).join('');

            grid.innerHTML = moviesHTML;
        }

        // í˜„ì¬ ê°€ì¤‘ì¹˜ ì €ì¥ ë³€ìˆ˜
        let currentWeights = {
            plot: 0.8,
            flow: 0.1,
            genre: 0.1
        };

        // ê´€ë ¨ì˜í™” ë¹„êµ í˜ì´ì§€ë¡œ ì´ë™
        function compareMovies(relatedTitle, relatedYear) {
            const originalTitle = "{{ movie.title }}";
            const originalYear = "{{ movie.year }}";
            
            // í˜„ì¬ ê°€ì¤‘ì¹˜ë¥¼ URLì— í¬í•¨
            const url = `/compare?original=${encodeURIComponent(originalTitle)}&original_year=${encodeURIComponent(originalYear)}&related=${encodeURIComponent(relatedTitle)}&related_year=${encodeURIComponent(relatedYear)}&plot_weight=${currentWeights.plot}&flow_weight=${currentWeights.flow}&genre_weight=${currentWeights.genre}`;
            window.location.href = url;
        }

        // ë¹„ìŠ·í•œ ì˜í™” ê²€ìƒ‰
        function searchSimilar() {
            const movieTitle = "{{ movie.title }}";
            window.location.href = `/?search=${encodeURIComponent(movieTitle)}`;
        }
    </script>
</body>
</html>